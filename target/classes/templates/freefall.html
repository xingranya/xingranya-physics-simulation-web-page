<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自由落体</title>
    <style>
        .animation-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            position: relative;
            height: 400px;
            overflow: hidden;
            background-color: #f0f8ff;
        }

        .result-container {
            background-color: #e8f4fc;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }

        .back-button {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 4px;
        }

        .back-button:hover {
            background-color: #2980b9;
        }

        .buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .buttons button {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>自由落体运动计算</h1>
    <form id="freefallForm">
        <label for="height">下落高度 (m):</label>
        <input type="number" id="height" name="height" th:value="${height}" step="0.1" required><br><br>
        
        <div class="buttons">
            <button type="button" id="calculateBtn">计算下落时间</button>
            <button type="button" id="animateBtn">播放动画</button>
        </div>
    </form>

    <div class="result-container" id="resultContainer" style="display: none;">
        <h3>计算结果：</h3>
        <p>下落时间 = <span id="timeResult">0.0</span> 秒</p>
        <p>终端速度 = 53 m/s</p>
        <p>空气阻力系数 = 0.5</p>
        <p>空气密度 = 1.2 kg/m³</p>
        <p>物体横截面积 = 0.04 m²</p>
    </div>

    <div class="animation-container">
        <canvas id="freefallCanvas" width="400" height="400"></canvas>
    </div>

    <a href="/" class="back-button">返回主页</a>

    <script th:inline="javascript">
        const canvas = document.getElementById('freefallCanvas');
        const ctx = canvas.getContext('2d');
        let ball = {
            x: 200,
            y: 50,
            radius: 15,
            vy: 0,
            scale: 50 // 像素/米的比例
        };
        let animationId = null;
        let isAnimating = false;
    
        function drawBall() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制天空背景
            ctx.fillStyle = '#f0f8ff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制地面
            ctx.beginPath();
            ctx.rect(0, 380, canvas.width, 20);
            ctx.fillStyle = '#8B4513';
            ctx.fill();
            
            // 绘制球体阴影
            ctx.beginPath();
            ctx.ellipse(ball.x, 380, ball.radius*0.8, ball.radius*0.3, 0, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fill();
            
            // 绘制球体
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#FF5722';
            ctx.fill();
            ctx.strokeStyle = '#E64A19';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    
        function startAnimation(height) {
            if (isAnimating) {
                cancelAnimationFrame(animationId);
            }
            isAnimating = true;
            let startTime;
            const groundY = 380 - ball.radius;
            ball.y = 50;
            ball.vy = 0;
            const scaledHeight = height * ball.scale;
    
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = (timestamp - startTime) / 1000;
                
                // 更真实的物理模拟
                const airResistance = 0.001 * ball.vy * ball.vy * (ball.vy > 0 ? 1 : -1);
                ball.vy += (9.80665 - airResistance) * 0.05;
                ball.y += ball.vy;
                
                if (ball.y >= groundY) {
                    ball.y = groundY;
                    ball.vy = -ball.vy * 0.6; // 反弹系数
                    
                    // 添加多次反弹效果
                    if (Math.abs(ball.vy) < 1) {
                        ball.vy = 0;
                        isAnimating = false;
                        cancelAnimationFrame(animationId);
                    }
                }
                
                drawBall();
                animationId = requestAnimationFrame(animate);
            }
    
            drawBall();
            animationId = requestAnimationFrame(animate);
        }

        // 计算下落时间
        function calculateFreefall(height) {
            let time = 0;
            let velocity = 0;
            let distance = 0;
            const deltaT = 0.01;
            const terminalVelocity = 53;
            
            while (distance < height) {
                const airResistance = 0.5 * 1.2 * 0.04 * velocity * velocity;
                const netForce = 9.80665 - airResistance;
                const acceleration = netForce;
                
                velocity += acceleration * deltaT;
                distance += velocity * deltaT;
                time += deltaT;
                
                if (velocity >= terminalVelocity) {
                    time += (height - distance) / terminalVelocity;
                    break;
                }
            }
            
            return time;
        }

        // 事件监听
        document.getElementById('calculateBtn').addEventListener('click', function() {
            const height = parseFloat(document.getElementById('height').value);
            const time = calculateFreefall(height);
            document.getElementById('timeResult').textContent = time.toFixed(2);
            document.getElementById('resultContainer').style.display = 'block';
        });

        document.getElementById('animateBtn').addEventListener('click', function() {
            const height = parseFloat(document.getElementById('height').value);
            startAnimation(height);
        });

        // 初始绘制
        drawBall();
    </script>
</body>
</html>