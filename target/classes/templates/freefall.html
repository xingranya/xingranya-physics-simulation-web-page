<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自由落体</title>
    <style>
        .animation-container {
            margin: 20px 0;
            border: 1px solid #ddd;
            position: relative;
            height: 400px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <h1>自由落体运动计算</h1>
    <form action="/calculateFreefall" method="post">
        <label for="height">下落高度 (m):</label>
        <input type="number" name="height" th:value="${height}" step="0.1" required><br><br>
        
        <button type="submit">计算下落时间</button>
    </form>

    <div th:if="${time}">
        <h3>计算结果：</h3>
        <p>下落时间 = <span th:text="${time}">0.0</span> 秒</p>
    </div>

    <div class="animation-container">
        <canvas id="freefallCanvas" width="400" height="400"></canvas>
    </div>

    <script th:inline="javascript">
        const canvas = document.getElementById('freefallCanvas');
        const ctx = canvas.getContext('2d');
        let ball = {
            x: 200,
            y: 50,
            radius: 15,
            vy: 0,
            scale: 50 // 像素/米的比例
        };
    
        function drawBall() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制更真实的地面
            ctx.beginPath();
            ctx.rect(0, 380, canvas.width, 20);
            ctx.fillStyle = '#8B4513';
            ctx.fill();
            
            // 绘制球体阴影
            ctx.beginPath();
            ctx.ellipse(ball.x, 380, ball.radius*0.8, ball.radius*0.3, 0, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(0,0,0,0.2)';
            ctx.fill();
            
            // 绘制球体
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = '#FF5722';
            ctx.fill();
            ctx.strokeStyle = '#E64A19';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    
        function startAnimation(height) {
            let startTime;
            const groundY = 380 - ball.radius;
            ball.y = 50;
            ball.vy = 0;
            const scaledHeight = height * ball.scale;
    
            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsed = (timestamp - startTime) / 1000;
                
                // 更真实的物理模拟
                const airResistance = 0.001 * ball.vy * ball.vy * (ball.vy > 0 ? 1 : -1);
                ball.vy += (9.80665 - airResistance) * 0.05;
                ball.y += ball.vy;
                
                if (ball.y >= groundY) {
                    ball.y = groundY;
                    ball.vy = -ball.vy * 0.6; // 反弹系数
                    
                    // 添加多次反弹效果
                    if (Math.abs(ball.vy) < 1) {
                        ball.vy = 0;
                        cancelAnimationFrame(animationId);
                    }
                }
                
                drawBall();
                animationId = requestAnimationFrame(animate);
            }
    
            drawBall();
            animationId = requestAnimationFrame(animate);
        }
    </script>
</body>
</html>